version: 2.1

commands: # a reusable command with parameters
  test:
    parameters:
      test-name:
        type: string
    steps:
      - run: 
          name: <<parameters.test-name>>
          command: npm run <<parameters.test-name>>
  install_and_build:
    steps:
      - checkout
      - run:
          name: Versions
          command: ./scripts/versions.sh
      - run:
          name: Install
          command: npm install
      - run:
          name: Build
          command: npm run build

          
jobs:
  general_test_node_v12:
    steps:
      - install_and_build
      - test:
          test-name: "test-general-tests"
    machine:
      image: ubuntu-2004:202010-01
  general_test_node_v14:
    steps:
      - install_and_build
      - test:
          test-name: "test-general-tests"
    machine:
      image: ubuntu-2004:202107-02
  configuration_test_node_v12:
    steps:
      - install_and_build
      - test:
          test-name: "test-configuration-tests"
    machine:
      image: ubuntu-2004:202010-01
  configuration_test_node_v14:
    steps:
      - install_and_build
      - test:
          test-name: "test-configuration-tests"
    machine:
      image: ubuntu-2004:202107-02
  npm_publish:
    docker:
      - image: cimg/node:14.18.1
    steps:
      - checkout
      - run:
          name: Publish
          command: ./scripts/npm-publish.sh

workflows:
  version: 2
  test_and_publish:
    jobs:
      - general_test_node_v12
      - general_test_node_v14
      - configuration_test_node_v12
      - configuration_test_node_v14
      - npm_publish:
          context: shardlabs
          filters:
            branches:
              only:
                - master
          requires:
            - general_test_node_v12
            - general_test_node_v14
            - configuration_test_node_v12
            - configuration_test_node_v14
